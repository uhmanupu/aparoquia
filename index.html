<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SACRISTIA - Agenda e Rotinas</title>
    <meta name="theme-color" content="#FCE4EC" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Sacristia" />

    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/12114/12114233.png" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/12114/12114233.png" />
    <link rel="manifest" href="./manifest.json" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        press: 'press 0.2s ease-out forwards',
                        fadeIn: 'fadeIn 0.4s ease-out'
                    },
                    keyframes: {
                        press: {
                            '0%': { transform: 'scale(1)', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' },
                            '100%': { transform: 'scale(1.12)', boxShadow: '0 8px 24px rgba(0,0,0,0.2)' }
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg-light-color: #FCE4EC;
            --card-translucent-bg: #FCE4EC;
            --agenda-card-solid-bg: #F06292;
            --date-button-inactive-bg: #FCE4EC;
            --primary-highlight: #F06299;
            --text-primary-color: #111111;
            --text-active-button-color: #FFFFFF;
            --liturgical-stroke: #F06292;
        }

        body {
            font-family: 'Merriweather', serif;
            background-color: var(--bg-light-color);
            color: var(--text-primary-color);
            transition: background-color 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.3s;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(248, 187, 208, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(228, 146, 193, 0.06) 0%, transparent 40%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body.dark-mode {
            --bg-light-color: #121212;
            --text-primary-color: #f0f0f0;
            --card-translucent-bg: #1e1e1e;
            --date-button-inactive-bg: #2a2a2a;
            --agenda-card-solid-bg: #c2185b;
            background-image: none;
            background-color: var(--bg-light-color);
        }

        .header-bg {
            background: var(--card-translucent-bg);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
            position: sticky;
            top: 0;
            z-index: 30;
            padding-top: env(safe-area-inset-top);
        }

        .header-title-text, .header-highlight-text {
            color: var(--text-primary-color);
            text-shadow:
                0.5px 0.5px 0 rgba(255,255,255,0.9),
                -0.5px -0.5px 0 rgba(255,255,255,0.9),
                0.5px -0.5px 0 rgba(255,255,255,0.9),
                -0.5px 0.5px 0 rgba(255,255,255,0.9);
        }

        .header-bg .lucide {
            color: var(--text-primary-color);
            filter: drop-shadow(0.5px 0.5px 0 rgba(255,255,255,0.9))
                    drop-shadow(-0.5px -0.5px 0 rgba(255,255,255,0.9));
        }

        .date-picker-scroll {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 12px 0 16px;
            margin: 0 -16px;
            padding-left: 16px;
        }
        .date-picker-scroll::-webkit-scrollbar { display: none; }

        .date-button {
            width: 74px;
            height: 74px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            border-radius: 50%;
            font-weight: 700;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            background: var(--date-button-inactive-bg);
            color: var(--text-primary-color);
            box-shadow:
                0 2px 8px rgba(0,0,0,0.06),
                inset 0 1px 0 rgba(255,255,255,0.6);
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .date-button.active {
            background: var(--primary-highlight);
            color: var(--text-active-button-color);
            font-weight: 900;
            transform: scale(1.12);
            box-shadow:
                0 6px 20px rgba(240, 98, 153, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .date-button span.day-number {
            font-size: 1.6rem;
            line-height: 1;
            display: block;
        }
        .date-button span.day-text {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .agenda-card {
            background: var(--agenda-card-solid-bg);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            padding: 1.25rem;
            text-align: center;
            margin-bottom: 0;
            border-radius: 1.25rem;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            position: relative;
            border-left: 4px solid var(--liturgical-stroke);
        }

        .task-header-card {
            background: var(--agenda-card-solid-bg);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            padding: 1.25rem;
            text-align: center;
            margin-bottom: 0;
            border-radius: 1.25rem;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .task-header-card h2 {
            font-size: 2.2rem;
            font-weight: 900;
            line-height: 1.1;
        }

        .agenda-card .time-title {
            font-size: 1.75rem;
            font-weight: 900;
            margin-bottom: 0.3rem;
        }
        .agenda-card .location-details {
            font-size: 1.15rem;
            font-weight: 700;
            opacity: 0.95;
        }
        .agenda-card .priest-name {
            font-size: 0.95rem;
            opacity: 0.85;
            margin-top: 0.2rem;
        }

        .checklist-content {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(255,255,255,0.7);
            border-radius: 0 0 1.25rem 1.25rem;
            padding: 1.2rem;
            color: #111;
            margin-top: -1px;
        }

        body.dark-mode .checklist-content {
            background: rgba(30, 30, 30, 0.95);
            color: #f0f0f0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed rgba(0,0,0,0.08);
        }
        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 0.85rem;
            accent-color: var(--primary-highlight);
            width: 1.35rem;
            height: 1.35rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .rotina-card {
            text-align: left;
            background: rgba(255, 255, 255, 0.95);
            margin-top: -1px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-radius: 0 0 1.25rem 1.25rem;
        }

        body.dark-mode .rotina-card {
            background: rgba(30, 30, 30, 0.95);
            color: #f0f0f0;
        }

        .rotina-list li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed rgba(0,0,0,0.08);
            font-size: 1rem;
            font-weight: 500;
        }
        .rotina-list li:last-child {
            border-bottom: none;
        }

        #santo-do-dia {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            color: var(--text-primary-color);
            text-shadow: none;
        }

        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }

        details[open] .agenda-card {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        footer {
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            color: #777;
            border-top: 1px solid rgba(0,0,0,0.05);
            background: var(--card-translucent-bg);
        }

        .progress-bar {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s ease;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-translucent-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.6rem 0;
            border-top: 1px solid rgba(0,0,0,0.08);
            z-index: 20;
        }

        body.dark-mode .nav-bottom {
            border-top-color: rgba(255,255,255,0.1);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-primary-color);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
        }

        .nav-btn .lucide {
            margin-bottom: 0.2rem;
        }

        .mark-all-btn {
            font-size: 0.75rem;
            color: var(--primary-highlight);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 0.3rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="header-bg">
        <div class="max-w-xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-start gap-3">
                <i data-lucide="cross" class="w-8 h-8 header-highlight-text mt-1"></i>
                <div>
                    <h1 class="text-2xl font-extrabold header-title-text leading-none">SACRISTIA</h1>
                    <p id="santo-do-dia"></p>
                </div>
            </div>
            <div class="flex items-center">
                <button id="theme-toggle" class="mr-2">
                    <i data-lucide="sun" class="w-6 h-6 header-highlight-text"></i>
                </button>
                <div class="text-right">
                    <p class="text-xs font-bold header-highlight-text">Ano Jubilar</p>
                    <p class="text-lg font-bold header-title-text whitespace-nowrap">1866 â€“ 2026</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-xl mx-auto px-4 py-6 w-full pb-20">
        <div id="agenda-section">
            <div class="mb-6">
                <div id="date-picker-container" class="date-picker-scroll"></div>
            </div>
            <div id="agenda-content" class="space-y-5"></div>
        </div>
    </main>

    <div class="nav-bottom">
        <button class="nav-btn" id="btn-hoje">
            <i data-lucide="calendar-check"></i>
            Hoje
        </button>
        <button class="nav-btn" id="btn-semana">
            <i data-lucide="calendar-days"></i>
            Semana
        </button>
        <button class="nav-btn" id="btn-config">
            <i data-lucide="settings"></i>
            Config
        </button>
    </div>

    <footer>
        Desenvolvido por Emanuel UchÃ´as
    </footer>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado:', reg.scope))
                    .catch(err => console.error('Erro ao registrar SW:', err));
            });
        }
    </script>

    <script>
        // ============== DADOS ==============
        function getTodayAgendaString() {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const dayNames = ["Domingo", "Segunda-feira", "TerÃ§a-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "SÃ¡bado"];
            return `${day}/${monthNames[today.getMonth()]} (${dayNames[today.getDay()]})`;
        }
        const TODAY_DATE = getTodayAgendaString();

        const AGENDA_DATA = [
            { "date": "24/Nov (Segunda-feira)", "dayOfWeek": "SEG", "time": "18:00", "title": "Santa Missa", "location": "Igreja Sagrado CoraÃ§Ã£o (Pe. Erick)" },
            { "date": "25/Nov (TerÃ§a-feira)", "dayOfWeek": "TER", "time": "19:00", "title": "Santa Missa", "location": "Setor 4 â€“ Bairro Pereiras (Pe. Edimilson)" },
            { "date": "25/Nov (TerÃ§a-feira)", "dayOfWeek": "TER", "time": "20:00", "title": "Santa Missa", "location": "Setor 7 â€“ Bairro Rio Acima II (Pe. Erick)" },
            { "date": "26/Nov (Quarta-feira)", "dayOfWeek": "QUA", "time": "19:00", "title": "Santa Missa", "location": "Setor 1 â€“ Bairro Mendes (Pe. Edimilson)" },
            { "date": "26/Nov (Quarta-feira)", "dayOfWeek": "QUA", "time": "19:00", "title": "Santa Missa", "location": "Setor 4 â€“ Bairro Ãgua Limpa (Pe. Erick)" },
            { "date": "27/Nov (Quinta-feira)", "dayOfWeek": "QUI", "time": "05:00", "title": "Santa Missa", "location": "Pedra Santa (Pe. Erick)" },
            { "date": "27/Nov (Quinta-feira)", "dayOfWeek": "QUI", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "27/Nov (Quinta-feira)", "dayOfWeek": "QUI", "time": "19:00", "title": "Santa Missa", "location": "Setor 1 â€“ Bairro MuquÃ©m (Pe. Erick)" },
            { "date": "28/Nov (Sexta-feira)", "dayOfWeek": "SEX", "time": "19:00", "title": "Santa Missa", "location": "Setor 7 â€“ Bairro Vargem Alegre (Pe. Edimilson)" },
            { "date": "29/Nov (SÃ¡bado)", "dayOfWeek": "SÃB", "time": "10:00", "title": "Santa Missa", "location": "Setor 1 â€“ Bairro Virgem do Socorro (Pe. Erick)" },
            { "date": "29/Nov (SÃ¡bado)", "dayOfWeek": "SÃB", "time": "19:00", "title": "Santa Missa", "location": "Setor 7 â€“ Bairro Roseirinha (Pe. Edimilson)" },
            { "date": "30/Nov (Domingo)", "dayOfWeek": "DOM", "time": "07:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "30/Nov (Domingo)", "dayOfWeek": "DOM", "time": "09:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "30/Nov (Domingo)", "dayOfWeek": "DOM", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "07/Dec (Domingo)", "dayOfWeek": "DOM", "time": "07:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "07/Dec (Domingo)", "dayOfWeek": "DOM", "time": "09:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "07/Dec (Domingo)", "dayOfWeek": "DOM", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "14/Dec (Domingo)", "dayOfWeek": "DOM", "time": "07:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "14/Dec (Domingo)", "dayOfWeek": "DOM", "time": "09:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "14/Dec (Domingo)", "dayOfWeek": "DOM", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "21/Dec (Domingo)", "dayOfWeek": "DOM", "time": "07:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "21/Dec (Domingo)", "dayOfWeek": "DOM", "time": "09:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "21/Dec (Domingo)", "dayOfWeek": "DOM", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "25/Dec (Quinta-feira)", "dayOfWeek": "QUI", "time": "19:00", "title": "Santa Missa Solene de Natal", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "28/Dec (Domingo)", "dayOfWeek": "DOM", "time": "07:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" },
            { "date": "28/Dec (Domingo)", "dayOfWeek": "DOM", "time": "09:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Erick)" },
            { "date": "28/Dec (Domingo)", "dayOfWeek": "DOM", "time": "19:00", "title": "Santa Missa", "location": "Igreja Matriz (Pe. Edimilson)" }
        ];

        const SACRISTY_CHECKLIST = [
            "Vinho", "Ãgua", "ManustÃ©rgio", "Corporal", "SanguÃ­neo", "HÃ³stias G", "HÃ³stia P", "Coleta", "Missal", "LecionÃ¡rio"
        ];

        const tarefasRotinaSemanal = {
            0: ["Organizar Mala de missas (DiÃ¡rio)", "Organizar Mala do Hotel (DiÃ¡rio)", "Higienizar vasos sagrados (ApÃ³s cada Missa)"],
            1: ["Varrer e limpar a igreja", "Varrer o passeio e escadaria central", "Lavar banheiro (sacristia e social)", "Lavar e passar alfaias e toalhas", "Higienizar vasos sagrados das malas", "Organizar Mala de missas (DiÃ¡rio)"],
            2: ["Lavar vestes de leitores", "Limpar bancos (Geral)", "Limpar portas (1Âª TerÃ§a-feira do MÃªs)", "Organizar Mala de missas (DiÃ¡rio)"],
            3: ["Organizar ArmÃ¡rio sacristia", "Limpar imagens e altares (1Âª e 3Âª do mÃªs)", "Organizar Mala de missas (DiÃ¡rio)"],
            4: ["Limpar coro (Geral)", "Varrer o passeio e escadaria central", "Limpar coro, escadaria e batistÃ©rio", "Passar vestes de leitores e toalha do altar", "Higienizar vasos sagrados das malas", "Organizar Mala de missas (DiÃ¡rio)"],
            5: ["Varrer e limpar a igreja", "Lavar banheiro (sacristia e social)", "Lavar alfaias e toalhas", "HigienizaÃ§Ã£o geral de vasos sagrados (CÃ¡lice, Ã¢mbulas, etc.)", "Organizar Mala de missas (DiÃ¡rio)"],
            6: ["Varrer o passeio e escadaria central", "Jogar Ã¡gua no passeio/escadaria", "Organizar Mala de missas (DiÃ¡rio)"]
        };

        const LITURGICAL_INFO_MAP = {
            "01/Nov": { color: "BRANCO", title: "Todos os Santos (Solenidade)" },
            "02/Nov": { color: "ROXO", title: "ComemoraÃ§Ã£o dos FiÃ©is Defuntos (Finados)" },
            "24/Nov": { color: "VERMELHO", title: "Santos AndrÃ© Dung-Lac e Comp., MÃ¡rtires (MO)" },
            "25/Nov": { color: "VERMELHO", title: "Santa Catarina de Alexandria, Virgem e MÃ¡rtir" },
            "26/Nov": { color: "VERDE", title: "SÃ£o Leonardo de Porto MaurÃ­cio (FÃ©ria)" },
            "27/Nov": { color: "BRANCO", title: "Nossa Senhora das GraÃ§as / Medalha Milagrosa (MF)" },
            "28/Nov": { color: "VERDE", title: "Santa Catarina LabourÃ© (FÃ©ria)" },
            "29/Nov": { color: "VERMELHO", title: "SÃ£o Saturnino de Tolosa (MemÃ³ria)" },
            "30/Nov": { color: "ROXO", title: "1Âº Domingo do Advento (Ano A)" },
            "07/Dec": { color: "ROXO", title: "2Âº Domingo do Advento" },
            "14/Dec": { color: "ROXO", title: "3Âº Domingo do Advento" },
            "21/Dec": { color: "ROSEO", title: "4Âº Domingo do Advento (Cor de Festejo)" },
            "25/Dec": { color: "BRANCO", title: "Natal do Senhor (Solenidade)" },
            "28/Dec": { color: "BRANCO", title: "Sagrada FamÃ­lia de Jesus, Maria e JosÃ© (Festa)" }
        };

        const LITURGICAL_COLORS = {
            "VERMELHO": ["#DC5F5F", "#FF8C8C", "#FFDCDC"],
            "BRANCO": ["#FDD835", "#FFF176", "#FFFDE7"],
            "VERDE": ["#8BC34A", "#C5E1A5", "#F1F8E9"],
            "ROXO": ["#9C27B0", "#E1BEE7", "#F3E5F5"],
            "ROSEO": ["#F06292", "#F8BBD0", "#FCE4EC"]
        };

        // ============== TEMA ESCURO ==============
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.querySelector('#theme-toggle i');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let isDarkMode = localStorage.getItem('darkMode') === 'true' || (localStorage.getItem('darkMode') === null && prefersDark);

        function updateThemeIcon() {
            sunIcon.setAttribute('data-lucide', isDarkMode ? 'moon' : 'sun');
            lucide.createIcons();
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            updateThemeIcon();
        }

        if (isDarkMode) document.body.classList.add('dark-mode');
        updateThemeIcon();
        themeToggle?.addEventListener('click', toggleDarkMode);

        // ============== SUPABASE ==============
        const SUPABASE_URL = 'https://nvefvewyxiwgwmyutbmk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZWZ2ZXd5eGl3Z3dweXV0Ym1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDExMjQ2NjYsImV4cCI6MjAxNjcwMDY2Nn0.7-jV5z5SgXlV70-RjLq-WJ7eN0fB3E1G1q-0u0-0u0';
        const CHECKLIST_TABLE_NAME = 'sacristy_tasks';

        let supabase = null;
        if (typeof window !== 'undefined' && window.supabase) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                console.error("Supabase error:", e);
            }
        }

        async function saveChecklistStatus(massId, taskId, isChecked) {
            if (!supabase) return;
            const { error } = await supabase
                .from(CHECKLIST_TABLE_NAME)
                .upsert({ mass_id: massId, task_id: taskId, is_checked: isChecked }, { onConflict: 'mass_id, task_id' });
            if (error) console.error("Erro ao salvar:", error.message);
        }

        async function loadChecklistStatus(massId) {
            if (!supabase) return [];
            const { data, error } = await supabase
                .from(CHECKLIST_TABLE_NAME)
                .select('task_id')
                .eq('mass_id', massId)
                .eq('is_checked', true);
            if (error) return [];
            return data.map(item => item.task_id);
        }

        // ============== FUNÃ‡Ã•ES AUXILIARES ==============
        function getLiturgicalInfo(dateStr) {
            const dayMonth = dateStr.split(' ')[0];
            const info = LITURGICAL_INFO_MAP[dayMonth];
            if (info) {
                const colors = LITURGICAL_COLORS[info.color] || LITURGICAL_COLORS["VERDE"];
                return { colorName: info.color, title: info.title, colors: colors };
            }
            return { colorName: "VERDE", title: "FÃ©ria (Dia Comum)", colors: LITURGICAL_COLORS["VERDE"] };
        }

        function applyDynamicTheme(colors, liturgicalTitle) {
            const [mainColorHex, translucentColorHex, lightBgColorHex] = colors;
            document.documentElement.style.setProperty('--bg-light-color', lightBgColorHex);
            document.documentElement.style.setProperty('--primary-highlight', mainColorHex);
            document.documentElement.style.setProperty('--agenda-card-solid-bg', mainColorHex);
            document.documentElement.style.setProperty('--card-translucent-bg', translucentColorHex);
            document.documentElement.style.setProperty('--date-button-inactive-bg', translucentColorHex);
            document.documentElement.style.setProperty('--liturgical-stroke', mainColorHex);
            const santoEl = document.getElementById('santo-do-dia');
            if (santoEl) santoEl.textContent = liturgicalTitle;

            const themeMeta = document.querySelector('meta[name="theme-color"]');
            if (themeMeta) themeMeta.setAttribute('content', lightBgColorHex);
        }

        function getDateObjectFromAgendaString(agendaDateStr) {
            const dateOnly = agendaDateStr.split('(')[0].trim();
            const [day, monthAbbr] = dateOnly.split('/');
            const currentYear = new Date().getFullYear();
            const monthMap = {'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11};
            const monthIndex = monthMap[monthAbbr];
            if (monthIndex === undefined) return new Date(NaN);
            return new Date(currentYear, monthIndex, parseInt(day));
        }

        // ============== RENDERIZAÃ‡ÃƒO ==============
        let uniqueDates = [];
        let currentSelectedDate = '';

        function getUniqueDates() {
            const dates = AGENDA_DATA.map(item => item.date.trim());
            uniqueDates = [...new Set(dates)];
            if (!currentSelectedDate) {
                currentSelectedDate = uniqueDates.find(date => date === TODAY_DATE) || uniqueDates[0];
            }
        }

        function renderDatePicker() {
            getUniqueDates();
            const container = document.getElementById('date-picker-container');
            if (!container) return;
            container.innerHTML = '';

            uniqueDates.forEach(fullDate => {
                const dayNumber = fullDate.split('/')[0];
                const dayText = fullDate.split('(')[1].replace(')', '').substring(0, 3).toUpperCase();
                const button = document.createElement('button');
                button.className = 'date-button';
                button.setAttribute('data-full-date', fullDate);
                button.innerHTML = `<span class="day-number">${dayNumber}</span><span class="day-text">${dayText}</span>`;
                button.onclick = () => selectDate(fullDate);
                if (fullDate === currentSelectedDate) {
                    button.classList.add('active');
                }
                container.appendChild(button);
            });

            const activeBtn = container.querySelector('.date-button.active');
            if (activeBtn) {
                setTimeout(() => {
                    container.scrollLeft = activeBtn.offsetLeft - (container.offsetWidth / 2) + (activeBtn.offsetWidth / 2);
                }, 50);
            }
        }

        async function groupEventsByLocation(events) {
            const groups = {};
            events.forEach(event => {
                const locationName = event.location.split('(')[0].trim();
                if (!groups[locationName]) groups[locationName] = [];
                groups[locationName].push(event);
            });
            return groups;
        }

        async function renderChecklist(containerId, massId, checklist, title = '') {
            const checkedTaskIds = await loadChecklistStatus(massId);
            let completed = 0;

            const checklistHtml = checklist.map((item, idx) => {
                const taskId = `task${idx}`;
                const isChecked = checkedTaskIds.includes(taskId);
                if (isChecked) completed++;
                const opacityClass = isChecked ? 'opacity-50' : '';
                return `
                    <li class="checklist-item ${opacityClass}">
                        <input type="checkbox" id="task-${massId}-${taskId}" ${isChecked ? 'checked' : ''}
                            onchange="toggleTask(this, '${massId}', '${taskId}', '${containerId}')">
                        <label for="task-${massId}-${taskId}" class="text-sm font-medium cursor-pointer">${item}</label>
                    </li>
                `;
            }).join('');

            const percent = checklist.length ? Math.round((completed / checklist.length) * 100) : 100;

            const section = document.createElement('div');
            section.className = 'agenda-details mt-4';
            section.innerHTML = `
                <div class="agenda-card">
                    <div class="time-title">${title}</div>
                </div>
                <div class="checklist-content">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs opacity-70">Itens para preparar:</p>
                        <span class="text-xs font-bold">${completed}/${checklist.length}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${percent}%"></div></div>
                    <button class="mark-all-btn" onclick="markAll('${massId}', this)">Marcar todos</button>
                    <ul class="list-none space-y-1 mt-2">${checklistHtml}</ul>
                </div>
            `;
            return section;
        }

        function toggleTask(checkbox, massId, taskId, containerId) {
            const isChecked = checkbox.checked;
            saveChecklistStatus(massId, taskId, isChecked);
            checkbox.closest('.checklist-item').classList.toggle('opacity-50', isChecked);

            checkbox.closest('.checklist-item').classList.add('animate-press');
            setTimeout(() => checkbox.closest('.checklist-item').classList.remove('animate-press'), 200);

            updateProgress(containerId);
        }

        function updateProgress(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const total = checkboxes.length;
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percent = total ? Math.round((checked / total) * 100) : 100;

            const fill = container.querySelector('.progress-fill');
            if (fill) fill.style.width = percent + '%';

            const counter = container.querySelector('.mark-all-btn').previousElementSibling;
            if (counter) counter.innerHTML = `<span class="text-xs font-bold">${checked}/${total}</span>`;
        }

        async function markAll(massId, btn) {
            const container = btn.closest('.checklist-content').parentElement;
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const newStatus = !allChecked;

            for (const cb of checkboxes) {
                cb.checked = newStatus;
                const taskId = cb.id.split('-').pop();
                await saveChecklistStatus(massId, taskId, newStatus);
                cb.closest('.checklist-item').classList.toggle('opacity-50', newStatus);
            }

            updateProgress(container.id);
        }

        async function renderAgenda() {
            const container = document.getElementById('agenda-content');
            if (!container) return;
            container.innerHTML = '';

            const events = AGENDA_DATA.filter(e => e.date.trim() === currentSelectedDate);
            await exibirRotinasDiarias(currentSelectedDate, container);

            if (events.length === 0) {
                container.innerHTML += `<div class="p-6 bg-white/90 dark:bg-gray-800 rounded-xl shadow-sm text-center"><p>Nenhuma Santa Missa agendada. (Sacristia em folga ðŸ˜‰)</p></div>`;
                lucide.createIcons();
                return;
            }

            const groups = await groupEventsByLocation(events);
            for (const [location, locEvents] of Object.entries(groups)) {
                for (const event of locEvents) {
                    const datePart = event.date.split(' ')[0].replace('/', '');
                    const timePart = event.time.replace(':', '');
                    const locationInitial = event.location.charAt(0);
                    const massId = `${datePart}_${timePart}_${locationInitial}`;
                    const sectionId = `section_${massId}`;

                    const section = await renderChecklist(sectionId, massId, SACRISTY_CHECKLIST, `${event.time} â€“ ${event.title} (${location})<br><small>(${event.location.split('(')[1].replace(')', '')})</small>`);
                    section.id = sectionId;
                    container.appendChild(section);
                }
            }

            lucide.createIcons();
        }

        async function exibirRotinasDiarias(currentDate, container) {
            const date = getDateObjectFromAgendaString(currentDate);
            const diaDaSemana = date.getDay();
            const dateOnly = currentDate.split(' ')[0].replace('/', '');
            const ROTINA_MASS_ID = `ROTINA_${dateOnly}`;
            const sectionId = `rotina_section_${dateOnly}`;
            const rotinasDoDia = [...(tarefasRotinaSemanal[diaDaSemana] || [])];

            if (diaDaSemana === 2) {
                let firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                while (firstDay.getDay() !== 2) firstDay.setDate(firstDay.getDate() + 1);
                if (date.getDate() !== firstDay.getDate()) {
                    rotinasDoDia = rotinasDoDia.filter(t => !t.includes("Limpar portas"));
                }
            }

            if (rotinasDoDia.length > 0) {
                const section = await renderChecklist(sectionId, ROTINA_MASS_ID, rotinasDoDia, "Tarefas DiÃ¡rias");
                container.appendChild(section);
            }
        }

        function selectDate(fullDate) {
            currentSelectedDate = fullDate;
            const liturgicalInfo = getLiturgicalInfo(fullDate);
            applyDynamicTheme(liturgicalInfo.colors, liturgicalInfo.title);
            renderAgenda();
            renderDatePicker();
        }

        // ============== EVENTOS ==============
        document.getElementById('btn-hoje')?.addEventListener('click', () => {
            selectDate(TODAY_DATE);
        });

        // InicializaÃ§Ã£o
        document.addEventListener('DOMContentLoaded', () => {
            getUniqueDates();
            const initialDate = uniqueDates.find(date => date === TODAY_DATE) || uniqueDates[0];
            selectDate(initialDate);
            lucide.createIcons();
        });
    </script>
</body>
</html>
