<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚õ™ Sacristia - Agenda Paroquial</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmpUl_X4g1H9VGvca9FzKeSzuOv8FHvKxOmwSvN4DIPiX73oPQkd9ZtxEa5tsD-P6gQO8&usqp=CAU') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
            line-height: 1.6;
        }

        .container {
            backdrop-filter: blur(12px);
            background: rgba(10, 10, 20, 0.75);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            width: 95%;
            max-width: 1000px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            overflow-x: auto;
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            color: #ffd700;
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
        }

        .agenda-title {
            text-align: center;
            font-size: 1.9rem;
            font-weight: bold;
            color: #fff;
            margin: 15px 0 25px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }

        .date-carousel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            overflow-x: auto;
            padding: 12px 0;
        }

        .date-item {
            background: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: bold;
            color: #e0e0ff;
        }

        .date-item:hover {
            transform: scale(1.06);
            background: rgba(60, 60, 90, 0.9);
        }

        .date-item.selected {
            background: #ffd700;
            color: #222;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.8);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.98rem;
            background: rgba(20, 20, 35, 0.6);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px;
            text-align: left;
        }

        th {
            background: rgba(30, 30, 50, 0.8);
            font-weight: bold;
            color: #ffd700;
        }

        tr:nth-child(even) {
            background: rgba(25, 25, 40, 0.5);
        }

        .check-btn {
            background: rgba(60, 60, 90, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            color: #fff;
            font-size: 1.25rem;
        }

        .check-btn:hover {
            background: rgba(80, 80, 120, 0.9);
            transform: scale(1.15);
        }

        .check-btn.checked {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .padre {
            color: #4fc3f7;
            font-weight: bold;
        }

        .highlight {
            background: rgba(255, 215, 0, 0.2);
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 5px;
        }

        .completed td {
            opacity: 0.8;
            text-decoration: line-through;
        }

        .saint-of-day {
            text-align: center;
            padding: 16px;
            margin: 16px 0;
            border-radius: 14px;
            font-size: 1.15rem;
            font-weight: bold;
            background: rgba(25, 25, 45, 0.7);
            border-left: 5px solid #6a4c93;
            box-shadow: 0 4px 14px rgba(0,0,0,0.3);
        }

        .tasks-section, .report-section, .footer {
            background: rgba(20, 20, 35, 0.6);
            border-radius: 14px;
            padding: 18px;
            margin: 20px 0;
        }

        .report-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .report-btn:hover {
            background: #45a049;
        }

        .report-output {
            margin-top: 15px;
            padding: 15px;
            background: rgba(10, 10, 20, 0.8);
            border-radius: 8px;
            color: #e0f7fa;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #ffd700;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffd700;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            table { font-size: 0.88rem; }
            .agenda-title { font-size: 1.6rem; }
            .date-item { padding: 8px 12px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚õ™ Sacristia - Agenda Paroquial</h1>
        <div class="agenda-title">Dezembro 2025</div>

        <div class="saint-of-day" id="saint-of-day">
            <div class="saint-icon">‚úùÔ∏è</div>
            <span id="saint-name">Carregando...</span>
        </div>

        <div class="date-carousel" id="date-carousel"></div>

        <div id="loading-container" class="loading">
            <span class="loading-spinner"></span> Carregando dados da Sacristia...
        </div>

        <table id="agenda-table" style="display:none;">
            <thead>
                <tr>
                    <th>Hor√°rio</th>
                    <th>Local / Atividade</th>
                    <th>Padre</th>
                    <th>Feito?</th>
                </tr>
            </thead>
            <tbody id="agenda-body"></tbody>
        </table>

        <div class="tasks-section" id="tasks-section" style="display:none;">
            <h2>üìã Tarefas da Sacristia</h2>
            <div id="tasks-list"></div>
        </div>

        <div class="report-section">
            <button class="report-btn" id="generate-report">üìä Gerar Relat√≥rio Semanal</button>
            <div class="report-output" id="report-output"></div>
        </div>

        <div class="footer">
            ‚úùÔ∏è Tarefas sincronizadas online com Supabase. Atualizado em tempo real.
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // üîë Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://nvefvewyxiwgwmyutbmk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZWZ2ZXd5eGl3Z3dweXV0Ym1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDExMjQ2NjYsImV4cCI6MjAxNjcwMDY2Nn0.7-jV5z5SgXlV70-RjLq-WJ7eN0fB3E1G1q-0u0-0u0';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Dados da agenda
        const agenda = {
            "01": [{ horario: "19:00", local: "4¬∫ dia da Novena", padre: "Pe. Erick", id: "01-1" }],
            "02": [
                { horario: "19:00", local: "Santa Missa Setor 5 ‚Äì Bairro Morangal", padre: "Pe. Edimilson", id: "02-1" },
                { horario: "19:00", local: "5¬∫ dia da Novena", padre: "Pe. Erick", id: "02-2" }
            ],
            "03": [
                { horario: "19:00", local: "Santa Missa Setor 6 ‚Äì Bairro Torres", padre: "Pe. Edimilson", id: "03-1" },
                { horario: "19:00", local: "6¬∫ dia da Novena", padre: "Pe. Erick", id: "03-2" }
            ],
            "04": [
                { horario: "09:00", local: "Santa Missa Abrigo S√£o Camilo", padre: "Pe. Edimilson", id: "04-1" },
                { horario: "19:00", local: "Santa Missa Setor 7 ‚Äì Bairro Vargem Alegre ‚Äì Formatura", padre: "Pe. Edimilson", id: "04-2" },
                { horario: "19:00", local: "7¬∫ dia da Novena", padre: "Pe. Erick", id: "04-3" }
            ],
            "05": [
                { horario: "19:00", local: "8¬∫ dia da Novena", padre: "Pe. Erick", id: "05-1" },
                { horario: "-----", local: "Compromisso", padre: "Pe. Edimilson", id: "05-2" }
            ],
            "06": [
                { horario: "11:00", local: "Casamento - Igreja Matriz", padre: "Pe. Edimilson", id: "06-1" },
                { horario: "16:00", local: "Santa Missa Igreja Matriz", padre: "Pe. Edimilson", id: "06-2" },
                { horario: "18:00", local: "Vig√≠lia Batismal", padre: "Pe. Edimilson", id: "06-3" },
                { horario: "19:00", local: "9¬∫ dia da Novena", padre: "Pe. Erick", id: "06-4" }
            ],
            "07": [
                { horario: "07:00", local: "Santa Missa Igreja Matriz", padre: "Pe. Edimilson", id: "07-1" },
                { horario: "08:00", local: "Santa Missa Setor 6 ‚Äì Bairro S√£o Jos√© da Mantiqueira - Confiss√£o Crismando", padre: "Pe. Erick", id: "07-2" },
                { horario: "09:00", local: "Santa Missa Igreja Matriz", padre: "Pe. Edimilson", id: "07-3" },
                { horario: "10:00", local: "Batizado ‚Äì Igreja Matriz", padre: "Pe. Edimilson", id: "07-4" },
                { horario: "10:30", local: "Santa Missa Setor 7 ‚Äì Bairro Rio Acima II", padre: "Pe. Erick", id: "07-5" },
                { horario: "16:00", local: "Santa Missa Setor 1 ‚Äì Bairro Retirinho", padre: "Pe. Edimilson", id: "07-6" },
                { horario: "19:00", local: "Primeiras V√©speras", padre: "Pe. Erick", id: "07-7" }
            ],
            "08": [
                { horario: "10:00", local: "Santa Missa Setor 7 ‚Äì Bairro Roseirinha", padre: "Pe. Erick", id: "08-1" },
                { horario: "10:00", local: "Santa Missa Igreja Matriz", padre: "Pe. Aylton", id: "08-2" },
                { horario: "19:00", local: "Santa Missa Igreja Matriz", padre: "Pe. Erick", id: "08-3" }
            ]
        };

        const santos = {
            "01": { nome: "2¬™-feira da 1¬™ Semana do Advento", cor: "#6a4c93", tipo: "ferial" },
            "02": { nome: "S. Crom√°cio de Aquileia (Mem√≥ria)", cor: "#6a4c93", tipo: "memoria" },
            "03": { nome: "S. Francisco Xavier (Mem√≥ria)", cor: "#6a4c93", tipo: "memoria" },
            "04": { nome: "5¬™-feira da 1¬™ Semana do Advento", cor: "#6a4c93", tipo: "ferial" },
            "05": { nome: "S. Sabas (Mem√≥ria)", cor: "#6a4c93", tipo: "memoria" },
            "06": { nome: "S√°bado da 1¬™ Semana do Advento", cor: "#6a4c93", tipo: "ferial" },
            "07": { nome: "2¬∫ Domingo do Advento", cor: "#6a4c93", tipo: "dominical" },
            "08": { nome: "Imaculada Concei√ß√£o de Maria Sant√≠ssima (Solenidade)", cor: "#ffffff", tipo: "solenidade" }
        };

        const diasNovena = ["01", "02", "03", "04", "05", "06", "07"];
        const corAdvento = "#6a4c93";
        const diasSemana = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];

        const tarefasPorDia = {
            "Segunda-feira": [
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Varrer e limpar" },
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Lavar banheiro sacristia" },
                { responsavel: "Emanuel", categoria: "Roupas", descricao: "Lavar alfaia e toalhas" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Varrer passeio da matriz e escadaria da porta central" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Lavar banheiro social (sal√£o)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar alfaia" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" },
                { responsavel: "Pietro", categoria: "Jardim", descricao: "Na seca, aguar jardim" }
            ],
            "Ter√ßa-feira": [
                { responsavel: "Emanuel", categoria: "Roupas", descricao: "Lavar vestes de leitores" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Manter trancado durante a semana (exceto quinta)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar t√∫nicas (quando for preciso)" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" }
            ],
            "Quarta-feira": [
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Folga" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Varrer passeio da matriz e escadaria da porta central" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Limpar imagens e altares (se for 1¬™ ou 3¬™ quarta do m√™s)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar alfaia" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Arm√°rio sacristia" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" },
                { responsavel: "Pietro", categoria: "Jardim", descricao: "Na seca, aguar jardim" }
            ],
            "Quinta-feira": [
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Limpar o coro, escadaria e batist√©rio" },
                { responsavel: "Emanuel", categoria: "Roupas", descricao: "Passar vestes de leitores e toalha do altar" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Varrer passeio da matriz e escadaria da porta central" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Manter trancado durante a semana (exceto hoje)" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Limpar imagens e altares (se for 1¬™ ou 3¬™ quarta do m√™s)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar alfaia" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" },
                { responsavel: "Pietro", categoria: "Jardim", descricao: "Na seca, aguar jardim" }
            ],
            "Sexta-feira": [
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Varrer e limpar" },
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Lavar banheiro sacristia" },
                { responsavel: "Emanuel", categoria: "Roupas", descricao: "Lavar alfaia e toalhas" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higieniza√ß√£o geral (c√°lice, √¢mbulas, bacia, jarros, galhetas, casti√ßais, cruz, tur√≠bulo, naveta...)" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Lavar banheiro social (sal√£o)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar alfaia" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" },
                { responsavel: "Pietro", categoria: "Jardim", descricao: "Na seca, aguar jardim" }
            ],
            "S√°bado": [
                { responsavel: "Emanuel", categoria: "Igreja", descricao: "Rastelar o jardim em torno da Igreja, quando ro√ßar" },
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Igreja", descricao: "Varrer passeio da matriz e escadaria da porta central (jogar √°gua)" },
                { responsavel: "Pietro", categoria: "Roupas", descricao: "Passar alfaia" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" },
                { responsavel: "Pietro", categoria: "Vasos Sagrados", descricao: "Higienizar vasos sagrados das malas" }
            ],
            "Domingo": [
                { responsavel: "Emanuel", categoria: "Vasos Sagrados", descricao: "Higienizar sempre depois da missa" },
                { responsavel: "Pietro", categoria: "Organizar", descricao: "Mala de missas" }
            ]
        };

        // Fun√ß√µes auxiliares
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        // Salvar no Supabase
        async function salvarTarefaNoBanco(id, feita) {
            try {
                const { error } = await supabase
                    .from('tarefas_sacristia')
                    .upsert({ id, feita }, { onConflict: 'id' });
                if (error) throw error;
                console.log(`‚úÖ Tarefa ${id} salva no Supabase.`);
            } catch (err) {
                console.error('Erro ao salvar no Supabase:', err.message);
            }
        }

        // Carregar do Supabase
        async function carregarTarefasDoBanco() {
            try {
                const { data, error } = await supabase
                    .from('tarefas_sacristia')
                    .select('id, feita');
                if (error) throw error;
                const estado = {};
                data.forEach(item => {
                    estado[item.id] = item.feita;
                    localStorage.setItem(item.id, item.feita.toString());
                });
                console.log('‚úÖ Tarefas carregadas do Supabase.');
                return estado;
            } catch (err) {
                console.error('Erro ao carregar do Supabase:', err.message);
                // Fallback para localStorage
                const estado = {};
                for (let i = 1; i <= 8; i++) {
                    const dia = String(i).padStart(2, '0');
                    const date = new Date(2025, 11, i);
                    const diaSemana = diasSemana[date.getDay()];
                    const tarefas = tarefasPorDia[diaSemana] || [];
                    tarefas.forEach(t => {
                        if (t.descricao === "Folga") return;
                        const taskId = `task-${t.responsavel}-${t.categoria}-${t.descricao.replace(/\s+/g, '-')}`;
                        estado[taskId] = localStorage.getItem(taskId) === 'true';
                    });
                }
                return estado;
            }
        }

        // Renderizar agenda e tarefas
        function renderAgenda(dia, estado) {
            const tbody = document.getElementById('agenda-body');
            const items = agenda[dia] || [];
            let html = '';
            const date = new Date(2025, 11, parseInt(dia));
            const diaSemana = diasSemana[date.getDay()];
            let corLiturgica = santos[dia]?.cor || "#6a4c93";
            if (diasNovena.includes(dia)) corLiturgica = corAdvento;

            document.querySelector('.container').style.borderColor = `rgba(${hexToRgb(corLiturgica)}, 0.4)`;
            document.querySelector('.saint-of-day').style.borderLeft = `5px solid ${corLiturgica}`;
            document.getElementById('saint-name').textContent = (santos[dia] || { nome: "Dia Comum" }).nome;

            items.forEach(item => {
                const isHighlighted = /Novena|Batizado|Casamento|Vig√≠lia/i.test(item.local);
                const feita = estado && estado[item.id] !== undefined ? estado[item.id] : localStorage.getItem(item.id) === 'true';
                const checkedClass = feita ? 'checked' : '';
                const checkText = feita ? '‚úì' : '‚òê';
                html += `
                <tr class="${feita ? 'completed' : ''}">
                    <td>${item.horario}</td>
                    <td class="${isHighlighted ? 'highlight' : ''}">${item.local}</td>
                    <td class="padre">${item.padre}</td>
                    <td class="checkbox-cell">
                        <button class="check-btn ${checkedClass}" data-id="${item.id}">${checkText}</button>
                    </td>
                </tr>
                `;
            });
            tbody.innerHTML = html;

            renderTasks(diaSemana, estado);
        }

        function renderTasks(diaSemana, estado) {
            const tasksList = document.getElementById('tasks-list');
            const tarefasDoDia = tarefasPorDia[diaSemana] || [];
            let html = '';
            const categorias = {};
            tarefasDoDia.forEach(t => {
                if (!categorias[t.categoria]) categorias[t.categoria] = [];
                categorias[t.categoria].push(t);
            });
            for (let cat in categorias) {
                html += `<div class="task-category"><h3>${cat}</h3>`;
                categorias[cat].forEach(task => {
                    if (task.descricao === "Folga") return;
                    const taskId = `task-${task.responsavel}-${task.categoria}-${task.descricao.replace(/\s+/g, '-')}`;
                    const feita = estado && estado[taskId] !== undefined ? estado[taskId] : localStorage.getItem(taskId) === 'true';
                    const checkedClass = feita ? 'checked' : '';
                    const checkText = feita ? '‚úì' : '‚òê';
                    html += `
                    <div class="task-item ${feita ? 'completed' : ''}">
                        <span class="task-name">${task.responsavel}: ${task.descricao}</span>
                        <button class="check-btn ${checkedClass}" data-id="${taskId}">${checkText}</button>
                    </div>
                    `;
                });
                html += `</div>`;
            }
            tasksList.innerHTML = html;
        }

        // Inicializa√ß√£o
        async function initApp() {
            try {
                // Mostrar loading
                document.getElementById('loading-container').style.display = 'block';
                document.getElementById('agenda-table').style.display = 'none';
                document.getElementById('tasks-section').style.display = 'none';

                // Carregar estado do banco
                const estado = await carregarTarefasDoBanco();

                // Esconder loading
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('agenda-table').style.display = 'table';
                document.getElementById('tasks-section').style.display = 'block';

                // Renderizar carrossel
                const carousel = document.getElementById('date-carousel');
                let html = '';
                for (let dia in agenda) {
                    const date = new Date(2025, 11, parseInt(dia));
                    const dayName = diasSemana[date.getDay()];
                    html += `<div class="date-item" data-dia="${dia}" title="${dayName}">${dia} ${dayName.slice(0,3)}</div>`;
                }
                carousel.innerHTML = html;

                const firstItem = carousel.querySelector('.date-item');
                if (firstItem) {
                    firstItem.classList.add('selected');
                    renderAgenda(firstItem.getAttribute('data-dia'), estado);
                }

                carousel.querySelectorAll('.date-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.querySelectorAll('.date-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        renderAgenda(this.getAttribute('data-dia'), estado);
                    });
                });

                // Evento de clique nas tarefas
                document.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('check-btn')) {
                        const btn = e.target;
                        const id = btn.getAttribute('data-id');
                        const wasChecked = btn.classList.contains('checked');
                        const newChecked = !wasChecked;

                        btn.textContent = newChecked ? '‚úì' : '‚òê';
                        btn.classList.toggle('checked', newChecked);
                        const parent = btn.closest('.task-item') || btn.closest('tr');
                        if (parent) parent.classList.toggle('completed', newChecked);

                        localStorage.setItem(id, newChecked.toString());
                        await salvarTarefaNoBanco(id, newChecked);
                    }
                });

                // Relat√≥rio
                document.getElementById('generate-report').addEventListener('click', function() {
                    generateReport(estado);
                });

            } catch (err) {
                console.error('Erro na inicializa√ß√£o:', err);
                // Mostrar mensagem de erro
                document.getElementById('loading-container').innerHTML = `
                    <div style="color: #ff5555; text-align: center; padding: 20px;">
                        ‚ö†Ô∏è Erro ao carregar dados.<br>
                        Verifique se a tabela "tarefas_sacristia" existe no Supabase.<br>
                        Voc√™ pode usar o modo offline clicando em "Gerar Relat√≥rio".
                    </div>
                `;
            }
        }

        // Relat√≥rio semanal
        function generateReport(estado) {
            let total = 0, done = 0;
            let emmanuelDone = 0, emmanuelTotal = 0;
            let pietroDone = 0, pietroTotal = 0;

            for (let i = 1; i <= 8; i++) {
                const date = new Date(2025, 11, i);
                const diaSemana = diasSemana[date.getDay()];
                const tarefas = tarefasPorDia[diaSemana] || [];
                tarefas.forEach(t => {
                    if (t.descricao === "Folga") return;
                    total++;
                    const id = `task-${t.responsavel}-${t.categoria}-${t.descricao.replace(/\s+/g, '-')}`;
                    const isDone = estado && estado[id] !== undefined ? estado[id] : localStorage.getItem(id) === 'true';
                    if (isDone) done++;
                    if (t.responsavel === "Emanuel") {
                        emmanuelTotal++;
                        if (isDone) emmanuelDone++;
                    } else if (t.responsavel === "Pietro") {
                        pietroTotal++;
                        if (isDone) pietroDone++;
                    }
                });
            }

            const emmanuelPct = emmanuelTotal > 0 ? ((emmanuelDone / emmanuelTotal) * 100).toFixed(1) : 0;
            const pietroPct = pietroTotal > 0 ? ((pietroDone / pietroTotal) * 100).toFixed(1) : 0;
            const geralPct = total > 0 ? ((done / total) * 100).toFixed(1) : 0;

            const reportText = `
RELAT√ìRIO SEMANAL ‚Äì DEZEMBRO 2025 (01 a 08)
============================================
Total geral: ${done}/${total} tarefas conclu√≠das (${geralPct}%)

Emanuel:
  Conclu√≠das: ${emmanuelDone}/${emmanuelTotal}
  Percentual: ${emmanuelPct}%

Pietro:
  Conclu√≠das: ${pietroDone}/${pietroTotal}
  Percentual: ${pietroPct}%

√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}
            `.trim();

            const output = document.getElementById('report-output');
            output.textContent = reportText;
            output.style.display = 'block';
        }

        // Iniciar
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
