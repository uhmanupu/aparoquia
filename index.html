<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚õ™ Sacristia - Agenda Paroquial</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmpUl_X4g1H9VGvca9FzKeSzuOv8FHvKxOmwSvN4DIPiX73oPQkd9ZtxEa5tsD-P6gQO8&usqp=CAU') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
            line-height: 1.6;
        }

        .container {
            backdrop-filter: blur(12px);
            background: rgba(10, 10, 20, 0.75); /* Mais escuro e com contraste */
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            width: 95%;
            max-width: 1000px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            overflow-x: auto;
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            color: #ffd700;
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
        }

        .agenda-title {
            text-align: center;
            font-size: 1.9rem;
            font-weight: bold;
            color: #fff;
            margin: 15px 0 25px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }

        .date-carousel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            overflow-x: auto;
            padding: 12px 0;
        }

        .date-item {
            background: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: bold;
            color: #e0e0ff;
        }

        .date-item:hover {
            transform: scale(1.06);
            background: rgba(60, 60, 90, 0.9);
        }

        .date-item.selected {
            background: #ffd700;
            color: #222;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.8);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.98rem;
            background: rgba(20, 20, 35, 0.6);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px;
            text-align: left;
        }

        th {
            background: rgba(30, 30, 50, 0.8);
            font-weight: bold;
            color: #ffd700;
        }

        tr:nth-child(even) {
            background: rgba(25, 25, 40, 0.5);
        }

        .check-btn {
            background: rgba(60, 60, 90, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            color: #fff;
            font-size: 1.25rem;
        }

        .check-btn:hover {
            background: rgba(80, 80, 120, 0.9);
            transform: scale(1.15);
        }

        .check-btn.checked {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .padre {
            color: #4fc3f7;
            font-weight: bold;
        }

        .highlight {
            background: rgba(255, 215, 0, 0.2);
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 5px;
        }

        .completed td {
            opacity: 0.8;
            text-decoration: line-through;
        }

        .saint-of-day {
            text-align: center;
            padding: 16px;
            margin: 16px 0;
            border-radius: 14px;
            font-size: 1.15rem;
            font-weight: bold;
            background: rgba(25, 25, 45, 0.7);
            border-left: 5px solid #6a4c93;
            box-shadow: 0 4px 14px rgba(0,0,0,0.3);
        }

        .tasks-section, .report-section, .footer {
            background: rgba(20, 20, 35, 0.6);
            border-radius: 14px;
            padding: 18px;
            margin: 20px 0;
        }

        .report-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .report-btn:hover {
            background: #45a049;
        }

        .report-output {
            margin-top: 15px;
            padding: 15px;
            background: rgba(10, 10, 20, 0.8);
            border-radius: 8px;
            color: #e0f7fa;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            table { font-size: 0.88rem; }
            .agenda-title { font-size: 1.6rem; }
            .date-item { padding: 8px 12px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚õ™ Sacristia - Agenda Paroquial</h1>
        <div class="agenda-title">Dezembro 2025</div>

        <div class="saint-of-day" id="saint-of-day">
            <div class="saint-icon">‚úùÔ∏è</div>
            <span id="saint-name">Carregando...</span>
        </div>

        <div class="date-carousel" id="date-carousel"></div>

        <table id="agenda-table">
            <thead>
                <tr>
                    <th>Hor√°rio</th>
                    <th>Local / Atividade</th>
                    <th>Padre</th>
                    <th>Feito?</th>
                </tr>
            </thead>
            <tbody id="agenda-body"></tbody>
        </table>

        <div class="tasks-section" id="tasks-section">
            <h2>üìã Tarefas da Sacristia</h2>
            <div id="tasks-list"></div>
        </div>

        <div class="report-section">
            <button class="report-btn" id="generate-report">üìä Gerar Relat√≥rio Semanal</button>
            <div class="report-output" id="report-output"></div>
        </div>

        <div class="footer">
            ‚úùÔ∏è Tarefas sincronizadas online com Supabase. Atualizado em tempo real.
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // üîë Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://nvefvewyxiwgwmyutbmk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZWZ2ZXd5eGl3Z3dweXV0Ym1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDExMjQ2NjYsImV4cCI6MjAxNjcwMDY2Nn0.7-jV5z5SgXlV70-RjLq-WJ7eN0fB3E1G1q-0u0-0u0';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ... (seus dados de agenda, santos, tarefasPorDia permanecem os mesmos) ...
        const agenda = { /* mesmo do c√≥digo anterior */ };
        const santos = { /* mesmo */ };
        const diasNovena = ["01", "02", "03", "04", "05", "06", "07"];
        const corAdvento = "#6a4c93";
        const diasSemana = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];
        const tarefasPorDia = { /* mesmo */ };

        // Fun√ß√£o para salvar no Supabase
        async function salvarTarefaNoBanco(id, feita) {
            try {
                const { error } = await supabase
                    .from('tarefas_sacristia')
                    .upsert({ id, feita }, { onConflict: 'id' });
                if (error) throw error;
                console.log(`‚úÖ Tarefa ${id} salva no Supabase.`);
            } catch (err) {
                console.error('Erro ao salvar no Supabase:', err.message);
            }
        }

        // Fun√ß√£o para carregar do Supabase
        async function carregarTarefasDoBanco() {
            try {
                const { data, error } = await supabase
                    .from('tarefas_sacristia')
                    .select('id, feita');
                if (error) throw error;
                const estado = {};
                data.forEach(item => {
                    estado[item.id] = item.feita;
                    // Salvar tamb√©m no localStorage para fallback offline
                    localStorage.setItem(item.id, item.feita.toString());
                });
                console.log('‚úÖ Tarefas carregadas do Supabase.');
                return estado;
            } catch (err) {
                console.error('Erro ao carregar do Supabase:', err.message);
                // Fallback para localStorage
                return null;
            }
        }

        // Renderiza√ß√£o (mesma l√≥gica, mas agora com estado do banco)
        async function renderAgendaComEstado(dia, estadoBanco = null) {
            const tbody = document.getElementById('agenda-body');
            const items = agenda[dia] || [];
            let html = '';
            const date = new Date(2025, 11, parseInt(dia));
            const diaSemana = diasSemana[date.getDay()];
            let corLiturgica = santos[dia]?.cor || "#6a4c93";
            if (diasNovena.includes(dia)) corLiturgica = corAdvento;

            // Atualiza estilo (mesmo que antes)
            document.querySelector('.container').style.borderColor = `rgba(${hexToRgb(corLiturgica)}, 0.4)`;
            document.querySelector('.saint-of-day').style.borderLeft = `5px solid ${corLiturgica}`;
            document.getElementById('saint-name').textContent = (santos[dia] || { nome: "Dia Comum" }).nome;

            items.forEach(item => {
                const isHighlighted = /Novena|Batizado|Casamento|Vig√≠lia/i.test(item.local);
                const feita = estadoBanco ? estadoBanco[item.id] : localStorage.getItem(item.id) === 'true';
                const checkedClass = feita ? 'checked' : '';
                const checkText = feita ? '‚úì' : '‚òê';
                html += `
                <tr class="${feita ? 'completed' : ''}">
                    <td>${item.horario}</td>
                    <td class="${isHighlighted ? 'highlight' : ''}">${item.local}</td>
                    <td class="padre">${item.padre}</td>
                    <td class="checkbox-cell">
                        <button class="check-btn ${checkedClass}" data-id="${item.id}">${checkText}</button>
                    </td>
                </tr>
                `;
            });
            tbody.innerHTML = html;
            renderTasks(diaSemana, estadoBanco);
        }

        function renderTasks(diaSemana, estadoBanco = null) {
            const tasksList = document.getElementById('tasks-list');
            const tarefasDoDia = tarefasPorDia[diaSemana] || [];
            let html = '';
            const categorias = {};
            tarefasDoDia.forEach(t => {
                if (!categorias[t.categoria]) categorias[t.categoria] = [];
                categorias[t.categoria].push(t);
            });
            for (let cat in categorias) {
                html += `<div class="task-category"><h3>${cat}</h3>`;
                categorias[cat].forEach(task => {
                    if (task.descricao === "Folga") return;
                    const taskId = `task-${task.responsavel}-${task.categoria}-${task.descricao.replace(/\s+/g, '-')}`;
                    const feita = estadoBanco ? estadoBanco[taskId] : localStorage.getItem(taskId) === 'true';
                    const checkedClass = feita ? 'checked' : '';
                    const checkText = feita ? '‚úì' : '‚òê';
                    html += `
                    <div class="task-item ${feita ? 'completed' : ''}">
                        <span class="task-name">${task.responsavel}: ${task.descricao}</span>
                        <button class="check-btn ${checkedClass}" data-id="${taskId}">${checkText}</button>
                    </div>
                    `;
                });
                html += `</div>`;
            }
            tasksList.innerHTML = html;
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        // Evento de clique
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('check-btn')) {
                const btn = e.target;
                const id = btn.getAttribute('data-id');
                const wasChecked = btn.classList.contains('checked');
                const newChecked = !wasChecked;

                // Atualiza visual
                btn.textContent = newChecked ? '‚úì' : '‚òê';
                btn.classList.toggle('checked', newChecked);
                const parent = btn.closest('.task-item') || btn.closest('tr');
                if (parent) parent.classList.toggle('completed', newChecked);

                // Salva no localStorage
                localStorage.setItem(id, newChecked.toString());

                // Salva no Supabase
                await salvarTarefaNoBanco(id, newChecked);
            }
        });

        // Relat√≥rio (usa localStorage como fallback, mas prioriza Supabase se carregado)
        async function generateReport() {
            // Tenta carregar do Supabase primeiro
            let estado = await carregarTarefasDoBanco();
            if (!estado) {
                // Fallback
                estado = {};
                for (let i = 1; i <= 8; i++) {
                    const dia = String(i).padStart(2, '0');
                    const date = new Date(2025, 11, i);
                    const diaSemana = diasSemana[date.getDay()];
                    const tarefas = tarefasPorDia[diaSemana] || [];
                    tarefas.forEach(t => {
                        if (t.descricao === "Folga") return;
                        const id = `task-${t.responsavel}-${t.categoria}-${t.descricao.replace(/\s+/g, '-')}`;
                        estado[id] = localStorage.getItem(id) === 'true';
                    });
                }
            }

            let total = 0, done = 0;
            let emmanuelDone = 0, emmanuelTotal = 0;
            let pietroDone = 0, pietroTotal = 0;

            for (let i = 1; i <= 8; i++) {
                const date = new Date(2025, 11, i);
                const diaSemana = diasSemana[date.getDay()];
                const tarefas = tarefasPorDia[diaSemana] || [];
                tarefas.forEach(t => {
                    if (t.descricao === "Folga") return;
                    total++;
                    const id = `task-${t.responsavel}-${t.categoria}-${t.descricao.replace(/\s+/g, '-')}`;
                    const isDone = estado[id] || false;
                    if (isDone) done++;
                    if (t.responsavel === "Emanuel") {
                        emmanuelTotal++;
                        if (isDone) emmanuelDone++;
                    } else if (t.responsavel === "Pietro") {
                        pietroTotal++;
                        if (isDone) pietroDone++;
                    }
                });
            }

            const emmanuelPct = emmanuelTotal > 0 ? ((emmanuelDone / emmanuelTotal) * 100).toFixed(1) : 0;
            const pietroPct = pietroTotal > 0 ? ((pietroDone / pietroTotal) * 100).toFixed(1) : 0;
            const geralPct = total > 0 ? ((done / total) * 100).toFixed(1) : 0;

            const reportText = `
RELAT√ìRIO SEMANAL ‚Äì DEZEMBRO 2025 (01 a 08)
============================================
Total geral: ${done}/${total} tarefas conclu√≠das (${geralPct}%)

Emanuel:
  Conclu√≠das: ${emmanuelDone}/${emmanuelTotal}
  Percentual: ${emmanuelPct}%

Pietro:
  Conclu√≠das: ${pietroDone}/${pietroTotal}
  Percentual: ${pietroPct}%

√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}
            `.trim();

            document.getElementById('report-output').textContent = reportText;
            document.getElementById('report-output').style.display = 'block';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar estado do Supabase
            const estadoBanco = await carregarTarefasDoBanco();
            
            // Renderizar carrossel
            const carousel = document.getElementById('date-carousel');
            let html = '';
            for (let dia in agenda) {
                const date = new Date(2025, 11, parseInt(dia));
                const dayName = diasSemana[date.getDay()];
                html += `<div class="date-item" data-dia="${dia}" title="${dayName}">${dia} ${dayName.slice(0,3)}</div>`;
            }
            carousel.innerHTML = html;
            const firstItem = carousel.querySelector('.date-item');
            if (firstItem) {
                firstItem.classList.add('selected');
                renderAgendaComEstado(firstItem.getAttribute('data-dia'), estadoBanco);
            }
            carousel.querySelectorAll('.date-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.date-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    renderAgendaComEstado(this.getAttribute('data-dia'), estadoBanco);
                });
            });

            // Relat√≥rio
            document.getElementById('generate-report').addEventListener('click', generateReport);

            // Notifica√ß√£o (opcional, pode manter)
        });
    </script>
</body>
</html>
